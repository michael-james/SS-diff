<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <title>Screenshot Review DEMO</title>
  </head>
  <body>
    <div class="container-fluid">

      <div class="row p-3">
        <div class="col-sm-auto">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="transSScheck" checked>
            <label class="form-check-label" for="defaultCheck1">
              Show translated SS
            </label>
          </div>
        </div>
        <div class="col-sm-auto">
          <input type="file" id="files" class="form-control-file" name="files[]" multiple />
        </div>
      </div>
      <output id="list"></output>
      <output id="text">
        <ul></ul>
      </output>
      <table class='table table-responsive table-hover table-sm mb-5' id="output">
        <thead class='thead-dark'></thead>
        <tbody></tbody>
      </table>

    </div>
  </body>



<!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <script src="diff.js"></script>

<script>
  var text = [];

  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object

    $('#text ul, #output tbody').empty();    

    // files is a FileList of File objects. List some properties.
    
    for (var i = 0, f; f = files[i]; i++) {
      var ver = "";
      if (i == 0) {
        ver = "old";
      } else if (i == 1) {
        ver = "new";
      } else {
        ver = "new" + i
      }

      

      $('#text ul').append('<li><strong>' + ver.toUpperCase() + ": " + escape(f.name) + '</strong> (' + (f.type || 'n/a') + ') - ' + f.size + ' bytes, last modified: ' + (f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a') + '</li>');

      screens = {};

      var reader = new FileReader();

    reader.onload = function(e) {
      // console.log(e)

      var result = reader.result;
      var transSSchecked = $('#transSScheck').is(":checked");

      // console.log(result);

      // allText.push(text);
      var json = JSON.parse(result);

      // const ordered = {};
      // Object.keys(unordered).sort().forEach(function(key) {
      //   ordered[key] = unordered[key];
      // });

      var screens = {};

      for (var j in json.resources) {
        // allText.push(j);
        var screen = j.substr(0, 14);
        // console.log(screen);
        var val = json.resources[j];
        // console.log(val);
        // console.log(j.substr(0,14));

        if (!screens[screen]) {
          screens[screen] = {};
        }

        screens[screen][j] = val;

        // html += "<tr><th>" + j + "</th><td>" + json.resources[j] + "</td></tr>"
      };
      // console.log(j.namespace)
      // console.log(screens);

      var $thead = $('#output thead');
      var $tbody = $('#output tbody');

      var langCode = json.language + "_" + json.locale;

      var header = {name: json.namespace, langCode: langCode, dir: json.direction}

      for (var h in header) {
        $thead.append("<tr class='table-secondary'><th colspan='" + (transSSchecked ? 2 : 1) + "'></th><th>" + h + "</th><th style='min-width: 400px'>" + header[h] + "</th><th style='min-width: 500px'></th></tr>");
      }

      $tbody.append(function() {
        html = "";
        var screenNum = 0;

        for (var s in screens) {
          html += "<tr class='table-primary'><th colspan='" + (transSSchecked ? 2 : 1) + "' class='pt-3'>" + s + "</th><th colspan='3' class='pt-3'>" + s + "</th></tr><tr>"

          if (s !== "DISPLAY_NAME") {
            var screenNumStr = "";
            if (screenNum < 100) {
              screenNumStr += "0";
              if (screenNum < 10) {
                screenNumStr += "0";
              }
            }
            screenNumStr += screenNum;

            var imgPathEN = "ex/TD0157/en_US/SS/PROMIS-29_" + screenNumStr + "_" + s + ".png";
            var imgPathFL = "ex/TD0157/" + langCode + "/SS/PROMIS-29_" + screenNumStr + "_" + s + ".png";
            // console.log(imgPath);

            var imgWidth = 750;
            html += "<td rowspan=" + Object.keys(screens[s]).length + "><img src='" + imgPathEN + "' style='max-width: " + imgWidth + "px'></img></td>"

            if (transSSchecked) {
             html += "<th rowspan=" + Object.keys(screens[s]).length + "><img src='" + imgPathFL + "' style='max-width: " + imgWidth + "px'></img></td>"
            }
          } else {
            html += "<td colspan='" + (transSSchecked ? 2 : 1) + "' rowspan=" + Object.keys(screens[s]).length + "></td>";
          }

          var firstline = true;

          for (var line in screens[s]) {
            if (!firstline) {
              html += "<tr>";
            }

            var rows = screens[s][line].length > 125 ? 3 : (screens[s][line].length > 65 ? 2 : 1);

            html += "<th style='min-width: 125px; width: 260px; max-width: 260px; white-space: normal; word-break:break-all;'>" + line.slice(15) + "</th><td>" + screens[s][line] + "</td><td><textarea style='width: 100%; font-size: 90%' rows='" + rows + "'>" + screens[s][line] + "</textarea></td></tr>"
            firstline = false;
          }

          screenNum++;
        }

        // console.log(html);

        return html
      });
      
      // console.log(JSON.stringify(j));
      //console.log(text);
      // console.log(JSON.stringify(json));
      // document.getElementById('text').innerHTML = document.getElementById('text').innerHTML + '<ul>' + JSON.stringify(allText, null, 4); + '</ul>';
      // document.getElementById('text').innerHTML = document.getElementById('text').innerHTML + '<table class="table">' + html + '</table>';

      text.push(screens);
    }
      reader.readAsText(f);

      
    }

    // console.log(text);

    // var allText = [{hi: 'michael'}];
    // JSON.stringify(allText[0]);


    
    // console.log(allText[0]);

    // document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';

    // document.getElementById('text').innerHTML = '<ul>' + allText.join(''); + '</ul>';

    // document.getElementById('text').innerHTML = '<ul>' + JSON.stringify(json) + '</ul>';

    
  }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>
</body>
</html>