<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <title>Screenshot Review DEMO</title>

    <style>

      /*text diff*/

      del {
        /*background: #FFE6E6;*/
        background: #f79c9c;
      }
      ins {
        /*background: #E6FFE6;*/
        background: #b4fbb4;
        text-decoration: none;
      }
      mute {
        color: #c6cace;
      }

      /*image diff*/

      #image-diff {
        width: 100%;
        height: 100%;
        position: relative;
        top: 0;
        left: 0;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
      }

      #image-container {
        /*aspect ratio for tablet is 1.7*/
        width: 700px;
        height: 412px;
      }
    </style>
  </head>
  <body style="font-family: sans-serif;">
    <div class="container-fluid">

      <div class="row p-3">
        <div class="col-sm-auto">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="transSScheck" checked>
            <label class="form-check-label" for="defaultCheck1">
              Show translated SS
            </label>
          </div>
        </div>
        <div class="col-sm-auto">
          <div class="custom-file">
            <input type="file" id="oldfiles" class="custom-file-input" name="files[]" multiple />
            <label class="custom-file-label" for="defaultCheck1">Old Files</label>
          </div>
        </div>
        <div class="col-sm-auto">
          <div class="custom-file">
            <input type="file" id="newfiles" class="custom-file-input" name="files[]" multiple />
            <label class="custom-file-label" for="defaultCheck1">New Files</label>
          </div>
        </div>
        <div class="col-sm-auto offset-md-1">
          <select class="custom-select" id="selectjson">
            <option selected disabled>(choose a json)</option>
          </select>
        </div>
        <div class="col-sm-auto">
          <button class="btn btn-primary" id="display">Display</button>
          <button class="btn btn-dark" id="reset">Reset</button>
        </div>
      </div>

      <output id="list"></output>
      <output id="text">
        <ul></ul>
      </output>
      <table class='table table-responsive table-hover table-sm mb-5' id="output">
        <thead class='thead-dark'></thead>
        <tbody></tbody>
      </table>

    </div>
  </body>



<!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <script src="diff-SS.js"></script>

<script>
      
  function readFile(f, ver) {
    // $('#text ul').append('<li><strong>' + ver.toUpperCase() + ": " + escape(f.name) + '</strong> (' + (f.type || 'n/a') + ') - ' + f.size + ' bytes, last modified: ' + (f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a') + '</li>');
    $('#text ul').append('<li><strong>' + ver.toUpperCase() + ": " + escape(f.name) + '</strong> - ' + f.size + ' bytes, last modified: ' + (f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a') + '</li>');


    var reader = new FileReader();
    var object = {};

    reader.onload = function(e) {
      var screens = {};
      // console.log(e)

      var result = reader.result;

      // console.log(result);

      // allText.push(text);
      var json = JSON.parse(result);

      var langCode = f.name.slice(-10).slice(0, 5);
      var langCodeJSON = json.language + "_" + json.locale;
      var name = json.namespace;
      object = {name: name, langCode: langCodeJSON, dir: json.direction, screens: {}};

      // const ordered = {};
      // Object.keys(unordered).sort().forEach(function(key) {
      //   ordered[key] = unordered[key];
      // });

      for (var j in json.resources) {
        // allText.push(j);
        var screen = j.substr(0, 14);
        // console.log(screen);
        var val = json.resources[j];
        // console.log(val);
        // console.log(j.substr(0,14));

        if (!object.screens[screen]) {
          object.screens[screen] = {};
        }

        // console.log(j);
        // console.log(val);

        object.screens[screen][j] = val;
        // console.log(object.screens[screen]);
      };

      if (!jsons[ver][langCode]) {
        jsons[ver][langCode]= {};
        if (ver == "new") {
          $('#selectjson').append("<option disabled>" + langCode + "</option>");
        }
      }

      if (ver == "new") {
        $('#selectjson option:contains(' + langCode + ')').parent().append("<option data-lang='" + langCode + "' data-name='" + name + "'>" + name + "</option>");
      }

      jsons[ver][langCode][name] = object;

      // if (!json[ver][langCode]) {
      //   json[ver][langCode] = {};
      // }

      // console.log(jsons);
      // jsons[ver][langCode][name] = object;

      // console.log(jsons);
    }
    
    reader.readAsText(f);
  }

  function displayDiff(langCode, name) {

    // warnings
    if (!jsons.old[langCode]) {
      alert("No old " + langCode + " jsons were selected.");
      return
    }

    if (!jsons.old[langCode][name]) {
      alert("No old " + langCode + " " + name + " json was selected.");
      return
    }

    if (!jsons.new[langCode]) {
      alert("No new " + langCode + " jsons were selected.");
      return
    }
    if (!jsons.new[langCode][name]) {
      alert("No new " + langCode + " " + name + " json was selected.");
      return
    }

    var oldData = jsons.old[langCode][name];
    var newData = jsons.new[langCode][name];

    var transSSchecked = $('#transSScheck').is(":checked");

    // console.log(oldData);
    // console.log(newData);

    var $thead = $('#output thead');
    var $tbody = $('#output tbody');

    var oldHeader = {"Namespace": oldData.name, "Language/ Locale": oldData.langCode, "Direction": oldData.dir}
    var newHeader = {"Namespace": newData.name, "Language/ Locale": newData.langCode, "Direction": newData.dir}

    for (var h in newHeader) {
      var diff = diffString(oldHeader[h], newHeader[h]);
      $thead.append("<tr class='table-secondary'><th colspan='" + (transSSchecked ? 2 : 1) + "'></th>" +
                    "<th>" + h + "</th>" + 
                    "<th style='min-width: 350px'>" + newHeader[h] + "</th>" +
                    "<th style='min-width: 300px'></th>" +
                    "<th style='width: 125px; max-width: 125px' class='pr-3'>" + diff + "</th>" +
                    "</tr>");
    }

    $tbody.append(function() {
      html = "";
      var screenNum = 0;

      for (var s in newData.screens) {
        var screenNameOnly = s.slice(s.indexOf('_') + 1);
        // console.log(screenNameOnly);

        html += "<tr class='table-primary'><th colspan='" + (transSSchecked ? 2 : 1) + "' class='py-3'>" + s + "</th><th class='py-3'>" + screenNameOnly + "</th><th class='py-3'>New (Formatted)</th><th class='py-3'>Edit</th><th class='py-3 pr-3'>Diff</th></tr><tr>"

        if (s !== "DISPLAY_NAME") {
          var screenNumStr = "";
          if (screenNum < 100) {
            screenNumStr += "0";
            if (screenNum < 10) {
              screenNumStr += "0";
            }
          }
          screenNumStr += screenNum;

          var imgPathEN = "ex/TD0157/en_US/SS/PROMIS-29_" + screenNumStr + "_" + s + ".png";
          var imgPathFL = "ex/TD0157/" + langCode + "/SS/PROMIS-29_" + screenNumStr + "_" + s + ".png";
          // console.log(imgPath);

          var imgWidth = 700;
          html += "<td rowspan=" + Object.keys(newData.screens[s]).length + "><img src='" + imgPathEN + "' style='max-width: " + imgWidth + "px'></img></td>"

          // image fl
          if (transSSchecked) {
            html += "<td rowspan=" + Object.keys(newData.screens[s]).length + "><div id='image-container'><div id='image-diff' style='background-image: url(" + imgPathFL + ")'></div></div></td>"

            // html += "<td rowspan=" + Object.keys(newData.screens[s]).length + "><img src='" + imgPathFL + "' style='max-width: " + imgWidth + "px'></img></td>"
          }
        } else {
          html += "<td colspan='" + (transSSchecked ? 2 : 1) + "' rowspan=" + Object.keys(newData.screens[s]).length + "></td>";
        }

        var firstline = true;

        for (var line in newData.screens[s]) {
          if (!firstline) {
            html += "<tr>";
          }

          var rows = Math.ceil(newData.screens[s][line].length / 39);
          var oldEscp = oldData.screens[s][line];
          var newEscp = newData.screens[s][line];
          var diff = diffString(oldEscp, newEscp)
            .replace(/<del>/g, "[del]").replace(/<ins>/g, "[ins]").replace(/<mute>/g, "[mute]") // disguise <del>, <ins>, and <mute>
            .replace(/<\/del>/g, "[\/del]").replace(/<\/ins>/g, "[\/ins]").replace(/<\/mute>/g, "[\/mute]") // disguise </del>, </ins>, and <mute>
            .replace(/>/g, "&gt;").replace(/</g, "&lt;") // escape < and >
            .replace(/\[del\]/g, "<del>").replace(/\[ins\]/g, "<ins>").replace(/\[mute\]/g, "<mute>") // reveal <del>, <ins>, and <mute>
            .replace(/\[\/del\]/g, "<\/del>").replace(/\[\/ins\]/g, "<\/ins>").replace(/\[\/mute\]/g, "<\/mute>"); // reveal </del>, </ins>, and </mute>
          // console.log(diff);

          var codeFontSize = 85;

          html += "<th style='min-width: 100px; width: 125px; max-width: 150px; white-space: normal; word-break:break-all;'>" + line.slice(15) + "</th>" +
            "<td>" + newData.screens[s][line] + "</td>" +
            "<td><textarea class='form-control' style='width: 100%; font-size: " + codeFontSize + "%; word-break: break-all' rows='" + rows + "'>" + newData.screens[s][line] + "</textarea></td>" +
            "<td style='font-size: " + codeFontSize + "%; word-break: break-all; width: 250px; max-width: 250px' class='pr-3'>" + diff + "</td>" +
            "</tr>"
          firstline = false;
        }

        screenNum++;
        html += "<th class='py-4' colspan='2' style='border: 0'><th class='py-4' colspan='4'></th>";
      }

      return html
    });
  }

  var jsons = {old: {}, new: {}};

  function handleFileSelect(evt, ver) {
    var files = evt.target.files; // FileList object
    
    for (var i = 0, f; f = files[i]; i++) {
      readFile(f, ver);

      // var ver = "";
      // if (i == 0) {
      //   ver = "old";
      // } else if (i == 1) {
      //   ver = "new";
      // } else {
      //   ver = "new" + i
      // }

      // filename langCode
      // var langCode = f.name.slice(-10).slice(0, 5);
      // console.log(langCode);
    }
  }

  document.getElementById('oldfiles').addEventListener('change', function(evt) {
    handleFileSelect(evt, "old");
  }, false);

  document.getElementById('newfiles').addEventListener('change', function(evt) {
    handleFileSelect(evt, "new");
  }, false);

  $('#reset').click(function() {
    // console.log('reset!');
    $('#text ul, #output thead, #output tbody').empty();
    jsons = {old: {}, new: {}};
  });

  $('#display').click(function() {
    $('#text ul, #output thead, #output tbody').empty();
    var $selected = $('#selectjson').find(":selected");
    var langCode = $selected.data('lang');
    var name = $selected.data('name');
    // console.log(langCode, name)
    displayDiff(langCode, name);
  });

  // testing
  // displayDiff("hu_HU", "PROMIS29");

</script>
</body>
</html>